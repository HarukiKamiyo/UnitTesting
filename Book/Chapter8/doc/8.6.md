## 8.6 ログ出力に対するテスト

### 8.6.1 そもそも、ログ出力をテストすべきか？

ログ出力はアプリケーションの「副作用」の一つですが、すべてのログをテストすべきではありません。ログは大きく 2 つの種類に分類されます。

- **サポート・ログ:** システムの管理者やサポート・スタッフが見ることを意図したログ。これはシステムの**「観察可能な振る舞い」**の一部であり、テストの対象となります。
- **診断ログ:** 開発者がデバッグのために使用するログ。これは**「実装の詳細」**であり、テストすべきではありません。

以下のコードは、ドメイン・モデル内に診断ログが混在している例です。

**リスト 8.3: User クラスで使われるログ出力**

```csharp
public class User
{
    public void ChangeEmail(string newEmail, Company company)
    {
        // 診断ログ：開発者向けの情報（テスト不要）
        _logger.Info($"Changing email for user {UserId} to {newEmail}");

        // ...（ビジネス・ロジック）...

        // サポート・ログ：ビジネス上の重要な変更を記録（テスト対象になり得る）
        _logger.Info($"User {UserId} changed type from {oldType} to {newType}");
    }
}
```

### 8.6.2 どのようにログ出力をテストすべきか？

ログ出力をテストする場合、単に `ILogger` のような汎用的なインターフェイスをモックにするのは避けるべきです。なぜなら、ログ出力とビジネス要件の結びつきが曖昧になり、テストが壊れやすくなるからです。

**推奨される方法：**

1.  **専用のインターフェイスを導入する:** `ILogger` を直接使うのではなく、ビジネス・ドメインに即したメソッドを持つ `IDomainLogger` を作成し、それをモックにします。
2.  **ドメイン・イベントを利用する:** ドメイン・モデルから直接ログを出力するのではなく、重要な変更を「ドメイン・イベント」として発行し、コントローラ側でログ出力に変換します。

**リスト 8.7: ログ出力をドメイン・イベントとして扱うように修正した UserController**

```csharp
public string ChangeEmail(int userId, string newEmail)
{
    // ...（準備・実行フェーズ）...
    user.ChangeEmail(newEmail, company);

    _database.SaveCompany(company);
    _database.SaveUser(user);

    // ログ出力が必要な事象をドメイン・イベントとして受け取り、ディスパッチャ経由で処理する
    // これによりドメイン・モデルからログ出力の責任を分離できる
    _eventDispatcher.Dispatch(user.DomainEvents);

    return "OK";
}
```

### 8.6.3 どのくらいのログを出力すれば十分なのか？

診断ログの過剰な出力は、以下の 2 つの問題を引き起こします。

- **プロダクション・コードの汚染:** ドメイン・モデルがログ出力コードで埋め尽くされ、本来のビジネス・ロジックが読みづらくなります。
- **ノイズの増大:** ログの量が増えすぎると、本当に重要な情報を見つけるのが難しくなります（信号対雑音比の低下）。

ドメイン・モデル内での診断ログ出力は極力避け、どうしても必要な場合のみ、コントローラ層などの境界部分で出力するようにリファクタリングすべきです。

### 8.6.4 どのようにログ出力オブジェクト (logger) を受け渡すのか？

ロガーを `static` なフィールド（環境コンテキスト）として保持するのはアンチパターンとされています。依存関係が隠れてしまい、テストが困難になるためです。

**解決策:**
ロガーは、コンストラクタやメソッドの引数として**明示的に注入**すべきです。

**リスト 8.9: ログ出力オブジェクトを明示的に受け渡す**

```csharp
public void ChangeEmail(string newEmail, Company company, ILogger logger)
{
    // 引数として受け取ったロガーを使用する
    logger.Info($"Changing email for user {UserId} to {newEmail}");
    // ...
}
```

---

**例えるなら：**
ログ出力のテストは、**「劇場の台本」**を確認するようなものです。
観客（ユーザーやサポート担当）に届く**「セリフ（サポート・ログ）」**が台本通りであるかは非常に重要なので、リハーサル（テスト）で厳格にチェックします。一方で、舞台裏で役者が自分たちのために書いた**「立ち位置のメモ（診断ログ）」**の内容までチェックする必要はありません。それをテストしすぎると、役者が少し動きを変えただけでリハーサルがやり直しになり、舞台の進行（開発）を妨げてしまうからです。
