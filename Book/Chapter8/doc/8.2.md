# 8.2 どのようなプロセス外依存をモックに置き換えるべきか？

このセクションでは、統合テストにおいて**プロセス外依存（データベースや外部システムなど）をどのように扱うべきか**、特に「モックに置き換えるべきもの」と「実物を使うべきもの」の違いについて解説されています。

## 1. プロセス外依存の 2 つの分類

すべてのプロセス外依存は、次の 2 種類に分けることができます。

- **管理下にある依存 (Managed Dependency):**
  - **対象のアプリケーションのみがアクセスできる**依存先です。
  - 代表例：他のアプリケーションと共有されていない**専用のデータベース**。
  - これらとの対話は「実装の詳細」であり、外部からは見えません。
- **管理下にない依存 (Unmanaged Dependency):**
  - **外部のアプリケーションからも観察可能**な依存先です。
  - 代表例：**メール・サービス**や**メッセージ・バス**。
  - これらとの対話は、システムが提供する「観察可能な振る舞い」の一部となります。

## 2. モックを使用する基準

統合テストを効果的に行うための原則は以下の通りです。

- **管理下にある依存は「実物」を使う:** 実装の詳細であるため、モックに置き換えずに実際のインスタンスを使用して、最終的な状態（データベースのデータなど）を検証します。
- **管理下にない依存は「モック」に置き換える:** 外部システムとの対話の仕様（契約）を維持することが重要であるため、モックを用いてそのやり取りを検証します。

## 3. 両方の性質を持つ複雑なケース（共有データベース）

一つのデータベースの中に、**「自作アプリ専用のテーブル」と「他アプリと共有しているテーブル」が混在している**場合があります。

- **共有されているテーブル:** 「管理下にない依存」として扱い、**モックに置き換えて**対話を検証すべきです。
- **共有されていないテーブル:** 「管理下にある依存」として扱い、**実物のデータベース**を使用して状態を検証します。

## 4. 注意点：管理下にある依存をモックにするリスク

もし、何らかの理由で管理下にある依存（データベースなど）をモックにしてしまうと、そのテストは**リファクタリングへの耐性を失い、単体テストと変わらない価値しか持たなくなります**。どうしても実物が使えない場合は、無理に統合テストを作成するのではなく、ドメイン・モデルの単体テストに注力すべきだとされています。

---

**例えるなら：**
「管理下にある依存」は**自宅の冷蔵庫**のようなものです。中身をどう整理しようが自由で、外の人には関係ありません。そのため、テストでも実際に扉を開けて中身（データ）を確認します。
一方で「管理下にない依存」は、**郵便局のポスト**に手紙を出すようなものです。一度投函すれば（メッセージを送れば）、あとは外部の仕組みに委ねられます。テストでは、実際に郵便局の裏側まで追いかけるのではなく、「正しくポストに投函したか（モックへの呼び出し）」を確認するだけで十分なのです。
