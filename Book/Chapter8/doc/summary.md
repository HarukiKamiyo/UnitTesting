## 第 8 章 まとめ：価値ある統合テストの指針

本章では、単体テストでは検証できない「システムがプロセス外依存と統合された状態で意図通りに機能するか」を確認するための統合テストについて学びました。

### 1. 統合テストの役割とテスト・ピラミッド

- **統合テストの定義:** 単体テストの条件（1 単位の振る舞い、実行速度、隔離）を 1 つでも満たさないテストを指します。主にコントローラを検証し、ドメイン・モデルとプロセス外依存の結びつきを確認します。
- **テスト・ピラミッドの維持:** 統合テストは保守コストが高く実行も遅いため、**「ビジネス・シナリオごとに 1 件のハッピー・パス」**と、単体テストで網羅できない異常ケースのみを対象とします。
- **早期失敗 (Fail Fast):** バグがある場合に即座に処理を中断させる設計にすることで、複雑な異常ケースの統合テストを不要にできます。

### 2. プロセス外依存の扱い（管理下 vs 管理下にない）

統合テストにおいて、依存先を「実物」にするか「モック」にするかは、その依存が「観察可能か」で決まります。

- **管理下にある依存 (Managed Dependency):** 自システムのみがアクセスする依存先（専用 DB など）。これは実装の詳細であるため、**実物を使用**し、最終的な「状態」を検証します。
- **管理下にない依存 (Unmanaged Dependency):** 外部システムからも観察可能な依存先（メール、メッセージ・バスなど）。これは「観察可能な振る舞い」であるため、**モックを使用**して「対話」を検証します。

### 3. 設計と実装のベスト・プラクティス

テストの質を高めるためには、プロダクション・コード側の設計も重要です。

- **インターフェイスの利用:** 実装クラスが 1 つしかない場合にインターフェイスを作るのは、**モックが必要な「管理下にない依存」のみ**に限定すべきです（YAGNI 原則）。
- **層の削減と境界の明確化:** 「ドメイン層」「アプリケーション・サービス層」「インフラ層」の 3 層に留め、間接参照を減らすことで認知負荷を下げます。
- **循環依存の解消:** コールバックなどの相互依存は、結果を戻り値で返すようにリファクタリングして一方通行にします。

#### コード例：循環依存の解消（リスト 8.10 相当）

```csharp
// リファクタリング前：CheckOutService と ReportGenerationService が互いに依存
// リファクタリング後：一方通行の依存にする
public class CheckOutService {
    public void CheckOut(int orderId) {
        var service = new ReportGenerationService();
        // コールバックを渡さず、戻り値として結果を受け取る
        Report report = service.GenerateReport(orderId);
    }
}
```

### 4. ログ出力のテスト

- **サポート・ログ:** 管理者が目にする「観察可能な振る舞い」であり、テスト対象です。
- **診断ログ:** 開発者向けの「実装の詳細」であり、テストすべきではありません。
- **依存性の注入:** ロガーを含むすべての依存先は、常にコンストラクタやメソッドの引数を通じて明示的に注入されるべきです。

#### コード例：ドメイン・イベントによるログ出力の分離（リスト 8.7 相当）

ログ出力を直接ドメイン・モデルに書かず、イベントを介してコントローラで処理することで、ドメイン・モデルをクリーンに保ちます。

```csharp
public string ChangeEmail(int userId, string newEmail) {
    // ...
    user.ChangeEmail(newEmail, company);
    // ログ出力を伴う可能性のある事象をドメイン・イベントとして処理
    _eventDispatcher.Dispatch(user.DomainEvents);
    return "OK";
}
```

---

**例えるなら：**
第 8 章のまとめは、**「精度の高いリトマス試験紙」**を作るためのガイドラインです。
すべての薬品（コード）を混ぜ合わせるのではなく、重要な反応（ビジネス・シナリオ）だけに絞って試験を行います。自分たちで管理している薬品（管理下にある依存）は直接変化を観察し、外部から届く薬品（管理下にない依存）には偽の反応器（モック）を用意して、正しく連絡が行ったかを確認します。こうして試験の手間を最小限に抑えつつ、工場全体（システム）が正しく動く自信を手に入れるのです。
