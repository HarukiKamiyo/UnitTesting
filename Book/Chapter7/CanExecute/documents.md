## 💡 7.4.1 確認後実行 (CanExecute/Execute) パターンの要約

この項の目的は、前の節で問題となった**コントローラ（アプリケーション・サービス）の複雑化を防ぎ**、**ビジネス・ロジックをドメイン・モデルに集中させる**ための具体的な設計パターンを提示することです。

### 目的：コントローラをビジネス・ロジックから解放する

パフォーマンスとドメイン・モデルのテストしやすさを両立させようとすると、コントローラに条件付きロジック（`if`文など）が流出し、複雑化する問題がありました。

確認後実行パターンは、この**コントローラへのビジネス・ロジックの流出を防ぐ**ことを主な目的としています。

### パターンの構造（CanExecute/Execute）

ドメイン・モデル（`User`クラスなど）に対して、以下の2つのメソッドを提供します。

1.  **`CanExecute` メソッド（例：`CanChangeEmail()`）**
    * **役割:** 実際の操作を実行する前に、**前提条件を満たしているか**を確認します。
    * **処理:** 実行可能であれば `null` を返し、実行できない場合はエラーメッセージを返します。
2.  **`Execute` メソッド（例：`ChangeEmail()`）**
    * **役割:** `CanExecute` で確認された**前提条件が満たされていること**を保証した上で、**実際の操作**を実行します。

> **NOTE:** サンプルコードでは理解しやすさを優先し、失敗を `string` で示していますが、実際のプロジェクトでは成功/失敗を伝える独自の**結果クラス**を戻り値として使用するのが望ましいとされています。

### 適用による効果（コントローラと単体テストへの貢献）

このパターンを適用することで、以下の2つの重要な効果が得られます。

* **コントローラからの知識排除:**
    * コントローラは、メールアドレスの変更に関する具体的な知識を必要としなくなります。
    * コントローラは、操作が可能かどうかをドメイン・モデル（例: `User`クラスの`CanChangeEmail`メソッド）に問い合わせて判断するだけになります。
* **ドメイン層への決定ロジックの集中:**
    * すべてのビジネスにおける決定（メールアドレスを変更できるか否かなど）がドメイン層に集約されます。
    * コントローラから、メール・アドレスを変更できるか否かを判断する`if`文が**本質的に取り除かれる**ことになります。これは、前提条件のテストは`User`クラスで行えば十分だからです。

結果として、このパターンは**コントローラの簡潔さを保ちながら**、**ビジネス・ロジックの決定をドメイン層に隔離**し、単体テストの容易性を維持するのに役立ちます。