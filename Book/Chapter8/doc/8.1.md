# 8.1 統合テストとは？

本章では、単体テストと統合テストをどのように使い分けるか、その黄金比（バランス）と、テストを減らすためのテクニックについて解説しています。

## 1. 単体テストと統合テストの役割分担（8.1.1）

コードの性質（複雑さと依存数）によって、テストのアプローチを決定します。

| コードの種類               | 特徴                           | テスト戦略                                                                               |
| :------------------------- | :----------------------------- | :--------------------------------------------------------------------------------------- |
| **① ドメイン・モデル**     | 複雑なロジック。依存は少ない。 | **徹底的に「単体テスト」する**<br>ビジネスロジックの要であり、テストのコスパが最高です。 |
| **② コントローラ**         | ロジックは単純。外部連携が主。 | **「統合テスト」でカバーする**<br>部品同士がつながって動くかを確認します。               |
| **③ 取るに足らないコード** | 単純すぎるコード。             | **テストしない**<br>労力の無駄です。                                                     |
| **④ 過度に複雑なコード**   | 複雑かつ依存が多い。           | **テスト前にリファクタリング**<br>① と ② に分割してからテストします。                    |

---

## 2. テスト・ピラミッド：数量のバランス（8.1.2）

テストスイート全体を健全に保つためには、テストの「数」と「検証内容」のバランスが重要です。

### 基本原則（ピラミッド型）

- **単体テスト（底辺・多数）**:
  - 実行が速く、修正も容易。
  - **「すべての異常ケース（エッジケース）」**と**「ビジネスロジックの組み合わせ」**をここで網羅します。
- **統合テスト（中間・少数）**:
  - 実行が遅く、保守コストが高い（プロセス外依存の維持が必要なため）。
  - **「ハッピー・パス（正常系）」を 1 つ**通すことで、システム全体の接続を確認します。
  - 単体テストでは検証できない異常ケースのみ、ここで扱います。

### 例外：単純なアプリケーションの場合

ビジネスロジックがほとんどない（CRUD 操作だけの）アプリでは、ピラミッド型にはなりません。単体テストと統合テストが同数程度（四角形）、あるいは「統合テストのみ」になることも許容されます。

---

## 3. 統合テストと「早期失敗（Fail Fast）」（8.1.3）

「統合テストで異常ケースをどこまでテストすべきか？」という悩みに対する答えが**「早期失敗（Fail Fast）」**です。

### 早期失敗（Fail Fast）とは？

予期せぬ状態になった瞬間、即座に処理を中断させる（例外を投げるなど）原則のことです。

- **メリット**: バグの早期発見、データの破損防止（変なデータのまま DB 保存されるのを防ぐ）。

### テスト戦略への応用

「早期失敗」の仕組みがコードに組み込まれていれば、**統合テストの数を減らせます。**

- **仕組み**: アプリケーションがおかしい状態（不正な入力など）になった際、ドメインモデルなどが即座にエラーを吐いて止まるように作っておく。
- **効果**: 「エラーで止まること」自体は単体テストで検証済みであるため、**わざわざ統合テストで同じ異常ケースを確認する必要がなくなります。**
- **結論**: 統合テストは、基本的に「ハッピー・パス（正常に動くルート）」の検証に集中し、異常系のテストは単体テストと Fail Fast の仕組みに任せることができます。

---

## まとめ：効率的なテスト戦略の 3 ステップ

1.  **ドメイン・モデル**に複雑な計算や判定を寄せ、**単体テスト**で異常系を含めてガッツリ検証する。
2.  **コントローラ**は、全体が繋がっているかを確認するために、**統合テスト**で主な成功ルート（ハッピー・パス）を流す。
3.  **早期失敗（Fail Fast）**を実装し、統合テストで細かいエラー確認をしなくて済むようにする。
